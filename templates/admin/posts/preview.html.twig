{% extends 'admin/layout.html.twig' %}

{% block title %}Preview:
	{{ post.title }}
{% endblock %}

{% block admin_content %}
	<div class="mb-6 flex items-center justify-between">
		<a href="{{ path('admin_posts') }}" class="flex items-center text-gray-500 hover:text-gray-700 transition-colors">
			<i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
			Back to Posts
		</a>
		<div class="flex gap-2">
			<span class="px-3 py-1 text-sm rounded-full
										                {% if post.status == 'published' %}bg-green-100 text-green-800
										                {% elseif post.status == 'rejected' %}bg-red-100 text-red-800
										                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
				Status:
				{{ post.status|capitalize }}
			</span>
		</div>
	</div>

	{# Annotation UI Layout #}
	<div
		class="flex flex-col lg:flex-row gap-6 max-w-[1400px] mx-auto">
		{# Preview Container #}
		<div class="flex-1 bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden h-fit relative" id="post-preview-container">
			{% if post.imageData %}
				<div class="h-64/ w-full overflow-hidden bg-gray-100">
					<img src="{{ path('post_image', {id: post.id}) }}" alt="{{ post.title }}" class="w-full h-full object-cover">
				</div>
			{% elseif post.imagePath %}
				<div class="h-64/ w-full overflow-hidden bg-gray-100">
					<img src="{{ asset('images/' ~ post.imagePath) }}" alt="{{ post.title }}" class="w-full h-full object-cover">
				</div>
			{% endif %}

			<div class="p-8 lg:p-12 relative" id="annotatable-content">
				<h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">{{ post.title }}</h1>

				<div class="flex items-center gap-4 text-sm text-gray-500 mb-8 pb-8 border-b border-gray-100">
					<div class="flex items-center gap-2">
						<div class="avatar placeholder">
							<div class="bg-teal-100 text-teal-700 rounded-full w-8 h-8 flex items-center justify-center">
								<span class="font-bold">{{ post.user.email|first|upper }}</span>
							</div>
						</div>
						<span>{{ post.user.email }}</span>
					</div>
					<span>â€¢</span>
					<span>{{ post.createdAt|date('F j, Y') }}</span>
				</div>

				<div class="prose prose-lg prose-teal max-w-none text-gray-700 leading-relaxed" id="post-body">
					{{ post.description|raw }}
				</div>
			</div>

			{# Sticky Moderation Footer #}
			<div class="bg-gray-50 p-4 border-t border-gray-200 flex items-center justify-between sticky bottom-0 z-50">
				<div class="text-sm text-gray-500 flex items-center gap-2">
					<i data-lucide="shield" class="w-4 h-4"></i>
					Review Moderation
				</div>
				<div class="flex gap-3">
					<form action="{{ path('admin_post_status', {id: post.id}) }}" method="POST">
						<input type="hidden" name="status" value="rejected">
						<button type="submit" class="btn btn-sm btn-error btn-outline gap-2 rounded-lg">
							<i data-lucide="x" class="w-4 h-4"></i>
							Reject
						</button>
					</form>
					<form action="{{ path('admin_post_status', {id: post.id}) }}" method="POST">
						<input type="hidden" name="status" value="published">
						<button type="submit" class="btn btn-sm btn-success text-white gap-2 rounded-lg shadow-sm">
							<i data-lucide="check" class="w-4 h-4"></i>
							Approve
						</button>
					</form>
				</div>
			</div>
		</div>

		{# Annotations Sidebar #}
		<aside class="w-full lg:w-80 space-y-4">
			<div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm sticky top-6">
				<div class="flex items-center justify-between mb-4 pb-2 border-b border-gray-50">
					<h3 class="font-bold text-gray-900 flex items-center gap-2">
						<i data-lucide="message-square" class="w-4 h-4 text-teal-600"></i>
						Feedback
					</h3>
					<span class="badge badge-ghost badge-sm font-bold" id="annotation-count">{{ post.annotations|length }}</span>
				</div>

				<div class="space-y-4 max-h-[calc(100vh-250px)] overflow-y-auto pr-2 custom-scrollbar" id="annotations-list">
					{% for annotation in post.annotations|sort((a, b) => b.createdAt <=> a.createdAt) %}
						<div class="p-3 bg-gray-50/50 rounded-lg border border-gray-100 group transition-all hover:bg-white hover:shadow-md {{ annotation.resolved ? 'opacity-50 grayscale' : '' }}" data-id="{{ annotation.id }}">
							<div class="flex items-center justify-between mb-2">
								<div class="flex items-center gap-2">
									<div class="w-6 h-6 rounded-full bg-teal-600 flex items-center justify-center text-[10px] text-white font-bold">
										{{ annotation.author.name|first|upper }}
									</div>
									<span class="text-xs font-bold text-gray-900">{{ annotation.author.name }}</span>
								</div>
								<span class="text-[10px] text-gray-400">{{ annotation.createdAt|date('M d, H:i') }}</span>
							</div>

							{% if annotation.selectedText %}
								<p class="text-[10px] text-teal-600 italic bg-teal-50 px-2 py-1 rounded mb-2 line-clamp-2">
									"{{ annotation.selectedText }}"
								</p>
							{% endif %}

							<p class="text-sm text-gray-700 leading-relaxed">{{ annotation.content }}</p>

							{% if not annotation.resolved %}
								<div class="mt-3 flex justify-end">
									<button class="btn btn-ghost btn-xs text-xs gap-1 opacity-0 group-hover:opacity-100 transition-opacity resolve-btn" onclick="resolveAnnotation({{ annotation.id }})">
										<i data-lucide="check-circle" class="w-3 h-3 text-teal-600"></i>
										Resolve
									</button>
								</div>
							{% endif %}
						</div>
					{% else %}
						<div class="text-center py-10" id="no-annotations-msg">
							<i data-lucide="message-circle" class="w-8 h-8 text-gray-200 mx-auto mb-2"></i>
							<p class="text-xs text-gray-400 italic">Select text to add feedback</p>
						</div>
					{% endfor %}
				</div>
			</div>
		</aside>
	</div>

	{# Annotation Modal #}
	<dialog id="annotation_modal" class="modal">
		<div class="modal-box max-w-sm rounded-2xl shadow-2xl border border-gray-100">
			<h3 class="font-bold text-lg mb-4 flex items-center gap-2">
				<i data-lucide="edit-3" class="w-5 h-5 text-teal-600"></i>
				Add Feedback
			</h3>

			<div id="selected-text-preview" class="mb-4 text-sm text-teal-600 italic bg-teal-50 p-3 rounded-xl border-l-4 border-teal-500 overflow-hidden text-ellipsis whitespace-nowrap"></div>

			<textarea id="annotation-content" class="textarea textarea-bordered w-full h-24 focus:border-teal-500 rounded-xl" placeholder="What needs to be changed?"></textarea>

			<div class="modal-action">
				<button class="btn btn-ghost rounded-xl" onclick="annotation_modal.close()">Cancel</button>
				<button class="btn btn-primary bg-teal-600 border-none hover:bg-teal-700 text-white rounded-xl" onclick="submitAnnotation()">
					Post Comment
				</button>
			</div>
		</div>
		<form method="dialog" class="modal-backdrop">
			<button>close</button>
		</form>
	</dialog>

	{# Floating Comment Button #}
	<button id="floating-comment-btn" class="hidden fixed z-[100] btn btn-circle btn-primary bg-teal-600 hover:bg-teal-700 border-none shadow-xl scale-90 transition-transform active:scale-75">
		<i data-lucide="message-square-plus" class="w-5 h-5 text-white"></i>
	</button>

	<style>
		.custom-scrollbar::-webkit-scrollbar {
			width: 4px;
		}
		.custom-scrollbar::-webkit-scrollbar-track {
			background: transparent;
		}
		.custom-scrollbar::-webkit-scrollbar-thumb {
			background: #e5e7eb;
			border-radius: 2px;
		}
		.custom-scrollbar::-webkit-scrollbar-thumb:hover {
			background: #d1d5db;
		}
		::selection {
			background-color: rgba(20, 184, 166, 0.2);
			color: inherit;
		}
		.highlight-annotation {
			background-color: rgba(20, 184, 166, 0.1);
			border-bottom: 2px solid #14b8a6;
			cursor: pointer;
		}
        #post-body a {
            color: #14b8a6;
            text-decoration: underline;
            text-underline-offset: 4px;
            font-weight: 700;
            transition: all 0.2s;
        }
        #post-body a:hover {
            color: #0d9488;
            background-color: rgba(20, 184, 166, 0.05);
            border-radius: 4px;
        }
	</style>

	<script>
		let currentSelection = null;

		document.addEventListener('DOMContentLoaded', () => {
			const previewBody = document.getElementById('post-body');
			const floatingBtn = document.getElementById('floating-comment-btn');

			const handleSelection = (e) => {
				const selection = window.getSelection();
				const text = selection.toString().trim();

				if (text && selection.rangeCount > 0 && isInside(selection.anchorNode, previewBody)) {
					currentSelection = {
						text: text,
						range: selection.getRangeAt(0).cloneRange()
					}

					const rect = selection.getRangeAt(0).getBoundingClientRect();
					
					// Position relative to viewport + scroll
					floatingBtn.style.left = `${rect.left + (rect.width / 2) - 20}px`;
					floatingBtn.style.top = `${rect.top + window.scrollY - 55}px`;
					
					floatingBtn.classList.remove('hidden');
					floatingBtn.classList.add('animate-bounce-subtle');
				} else {
					if (e && e.target && e.target.closest('#floating-comment-btn')) return;
					floatingBtn.classList.add('hidden');
				}
			};

			document.addEventListener('mouseup', handleSelection);
			
			// Handle selection via keyboard
			document.addEventListener('keyup', (e) => {
				if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'].includes(e.key)) {
					handleSelection();
				}
			});

			floatingBtn.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();
				document.getElementById('selected-text-preview').innerText = `"${currentSelection.text}"`;
				annotation_modal.showModal();
				floatingBtn.classList.add('hidden');
				setTimeout(() => document.getElementById('annotation-content').focus(), 100);
			});
		});

		function isInside(node, parent) {
			while (node) {
				if (node === parent) return true;
				node = node.parentNode;
			}
			return false;
		}

		async function submitAnnotation() {
			const content = document.getElementById('annotation-content').value.trim();
			if (!content) return;

			const submitBtn = document.querySelector('#annotation_modal .btn-primary');
			const originalHtml = submitBtn.innerHTML;
			
			submitBtn.disabled = true;
			submitBtn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Posting...';

			try {
				const response = await fetch("{{ path('admin_post_annotate', {id: post.id}) }}", {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						content: content,
						selectedText: currentSelection.text,
						contextData: {}
					})
				});

				const data = await response.json();
				if (data.status === 'success') {
					addAnnotationToList(data.annotation);
					annotation_modal.close();
					document.getElementById('annotation-content').value = '';
					const noMsg = document.getElementById('no-annotations-msg');
					if (noMsg) noMsg.remove();
					
					// Flash success state?
				} else {
					throw new Error(data.message || 'Failed to post');
				}
			} catch (error) {
				console.error(error);
				alert("Error: " + error.message);
			} finally {
				submitBtn.disabled = false;
				submitBtn.innerHTML = originalHtml;
			}
		}

		function addAnnotationToList(ann) {
			const list = document.getElementById('annotations-list');
			const html = `
				<div class="p-3 bg-white rounded-lg border border-teal-100 shadow-sm animate-in fade-in slide-in-from-right-4 duration-300" data-id="${ann.id}">
					<div class="flex items-center justify-between mb-2">
						<div class="flex items-center gap-2">
							<div class="w-6 h-6 rounded-full bg-teal-600 flex items-center justify-center text-[10px] text-white font-bold">
								${ann.authorName.charAt(0).toUpperCase()}
							</div>
							<span class="text-xs font-bold text-gray-900">${ann.authorName}</span>
						</div>
						<span class="text-[10px] text-gray-400">Just now</span>
					</div>
					<p class="text-[10px] text-teal-600 italic bg-teal-50 px-2 py-1 rounded mb-2 line-clamp-1 border-l-2 border-teal-500">
						"${ann.selectedText || currentSelection.text}"
					</p>
					<p class="text-sm text-gray-700 leading-relaxed">${ann.content}</p>
				</div>
			`;
			list.insertAdjacentHTML('afterbegin', html);

			const countBtn = document.getElementById('annotation-count');
			countBtn.innerText = parseInt(countBtn.innerText) + 1;

			if (window.lucide) window.lucide.createIcons();
		}

		async function resolveAnnotation(id) {
			if (!confirm('Resolve this feedback?')) return;

			try {
				const response = await fetch(`/admin/annotations/${id}/resolve`, {
					method: 'POST'
				});
				if (response.ok) {
					const row = document.querySelector(`[data-id="${id}"]`);
					if (row) {
						row.classList.add('opacity-50', 'grayscale');
						const btn = row.querySelector('.resolve-btn');
						if (btn) btn.remove();
					}
				}
			} catch (error) {
				console.error(error);
			}
		}
	</script>
{% endblock %}
