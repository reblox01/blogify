{% extends 'admin/layout.html.twig' %}

{% block title %}Preview:
	{{ post.title }}
{% endblock %}

{% block admin_content %}
	<div class="mb-6 flex items-center justify-between">
		<a href="{{ path('admin_posts') }}" class="flex items-center text-gray-500 hover:text-gray-700 transition-colors">
			<i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
			Back to Posts
		</a>
		<div class="flex gap-2">
			<span class="px-3 py-1 text-sm rounded-full font-medium
										                {% if post.status == 'published' %}bg-green-100 text-green-800
										                {% elseif post.status == 'rejected' %}bg-red-100 text-red-800
										                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
				Status:
				{{ post.status|capitalize }}
			</span>
		</div>
	</div>

	{# Main Layout #}
	<div
		class="flex flex-col lg:flex-row gap-6 max-w-[1400px] mx-auto">

		{# Blog Content Card #}
		<div class="flex-1 bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden h-fit relative transition-all duration-300" id="post-preview-container">
			{% if post.imageData %}
				<div class="w-full overflow-hidden bg-gray-100">
					<img src="{{ path('post_image', {id: post.id}) }}" alt="{{ post.title }}" class="w-full h-full object-cover">
				</div>
			{% elseif post.imagePath %}
				<div class="w-full overflow-hidden bg-gray-100">
					<img src="{{ asset('images/' ~ post.imagePath) }}" alt="{{ post.title }}" class="w-full h-full object-cover">
				</div>
			{% endif %}

			<div class="p-8 lg:p-12 relative" id="annotatable-content">
				<h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">{{ post.title }}</h1>

				<div class="flex items-center gap-4 text-sm text-gray-500 mb-8 pb-8 border-b border-gray-100">
					<div class="flex items-center gap-2">
						<div class="avatar placeholder">
							<div class="bg-teal-100 text-teal-700 rounded-full w-8 h-8 flex items-center justify-center">
								<span class="font-bold">{{ post.user.email|first|upper }}</span>
							</div>
						</div>
						<span class="font-medium text-gray-700">{{ post.user.email }}</span>
					</div>
					<span>•</span>
					<span>{{ post.createdAt|date('F j, Y') }}</span>
				</div>

				<div class="prose prose-lg prose-teal max-w-none text-gray-700 leading-relaxed overflow-visible" id="post-body">
					{{ post.description|raw }}
				</div>
			</div>

			{# Moderation Toolbar (Sticky Footer) #}
			<div class="bg-gray-50 p-4 border-t border-gray-200 flex items-center justify-between sticky bottom-0 z-50 rounded-b-xl">
				<div class="text-sm text-gray-500 flex items-center gap-2">
					<i data-lucide="shield-check" class="w-4 h-4 text-teal-600"></i>
					<span class="font-medium">Editorial Review</span>
				</div>

				{% if post.status != 'published' %}
					<div class="flex gap-3">
						<form action="{{ path('admin_post_status', {id: post.id}) }}" method="POST">
							<input type="hidden" name="status" value="rejected">
							<button type="submit" class="btn btn-sm btn-error btn-outline gap-2 rounded-lg hover:shadow-md transition-all">
								<i data-lucide="x" class="w-4 h-4"></i>
								Reject
							</button>
						</form>
						<form action="{{ path('admin_post_status', {id: post.id}) }}" method="POST">
							<input type="hidden" name="status" value="published">
							<button type="submit" class="btn btn-sm btn-success text-white gap-2 rounded-lg shadow-sm hover:shadow-md transition-all">
								<i data-lucide="check" class="w-4 h-4"></i>
								Approve Post
							</button>
						</form>
					</div>
				{% else %}
					<div class="flex items-center gap-2 text-green-600 font-bold text-sm bg-green-50 px-4 py-1.5 rounded-full border border-green-100">
						<i data-lucide="globe" class="w-4 h-4"></i>
						Currently Live
					</div>
				{% endif %}
			</div>
		</div>

		{# Sidebar (Comments & Metadata) #}
		<aside class="w-full lg:w-80 space-y-4">
			<div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm sticky top-6">
				<div class="flex items-center justify-between mb-4 pb-2 border-b border-gray-50">
					<h3 class="font-bold text-gray-900 flex items-center gap-2">
						<i data-lucide="message-square" class="w-4 h-4 text-teal-600"></i>
						Annotations
					</h3>
					<span class="badge badge-ghost badge-sm font-bold" id="annotation-count">{{ post.annotations|length }}</span>
				</div>

				<div class="space-y-4 max-h-[calc(100vh-250px)] overflow-y-auto pr-2 custom-scrollbar" id="annotations-list">
					{% for annotation in post.annotations|sort((a, b) => b.createdAt <=> a.createdAt) %}
						{% set isAuthor = annotation.author == app.user %}
						<div class="p-3 bg-gray-50/50 rounded-lg border border-gray-100 group transition-all hover:bg-white hover:shadow-md {{ annotation.resolved ? 'opacity-50 grayscale' : 'border-l-4' }} relative" data-id="{{ annotation.id }}" data-selected-text="{{ annotation.selectedText }}" style="{% if not annotation.resolved %}border-left-color: #14b8a6;{% endif %}">

							<div class="flex items-center justify-between mb-2">
								<div class="flex items-center gap-2">
									<div class="w-6 h-6 rounded-full bg-teal-600 flex items-center justify-center text-[10px] text-white font-bold author-avatar">
										{{ annotation.author.name|first|upper }}
									</div>
									<span class="text-xs font-bold text-gray-900 author-name">{{ annotation.author.name }}</span>
								</div>
								<span class="text-[10px] text-gray-400 font-medium annotation-time">{{ annotation.createdAt|date('M d, H:i') }}</span>
							</div>

							{% if annotation.selectedText %}
								<p class="text-[10px] text-teal-600 italic bg-teal-50 px-2 py-1.5 rounded mb-2 line-clamp-2 excerpt-box">
									"{{ annotation.selectedText }}"
								</p>
							{% endif %}

							<p class="text-sm text-gray-700 leading-relaxed mb-1">{{ annotation.content }}</p>

							{% if not annotation.resolved %}
								<div class="mt-3 flex justify-end gap-1">
									{% if isAuthor %}
										<button class="btn btn-ghost btn-xs text-[10px] text-error opacity-0 group-hover:opacity-100 transition-opacity px-1" title="Delete" onclick="deleteAnnotation({{ annotation.id }})">
											<i data-lucide="trash-2" class="w-3 h-3"></i>
											Delete
										</button>
									{% endif %}
									<button class="btn btn-ghost btn-xs text-[10px] text-teal-600 opacity-0 group-hover:opacity-100 transition-opacity px-1 resolve-btn" title="Mark as resolved" onclick="resolveAnnotation({{ annotation.id }})">
										<i data-lucide="check-circle" class="w-3 h-3"></i>
										Resolve
									</button>
								</div>
							{% endif %}
						</div>
					{% else %}
						<div class="text-center py-10" id="no-annotations-msg">
							<i data-lucide="message-circle" class="w-8 h-8 text-gray-200 mx-auto mb-2"></i>
							<p class="text-xs text-gray-400 italic">Highlight text to provide feedback</p>
						</div>
					{% endfor %}
				</div>
			</div>
		</aside>
	</div>

	{# Annotation Modal #}
	<dialog id="annotation_modal" class="modal">
		<div class="modal-box max-w-sm rounded-2xl shadow-2xl border border-gray-100">
			<h3 class="font-bold text-lg mb-4 flex items-center gap-2">
				<i data-lucide="pencil-line" class="w-5 h-5 text-teal-600"></i>
				Add Feedback
			</h3>

			<div id="selected-text-preview" class="mb-4 text-sm text-teal-600 italic bg-teal-50 p-3 rounded-xl border-l-4 border-teal-500 overflow-hidden text-ellipsis whitespace-nowrap"></div>

			<textarea id="annotation-content" class="textarea textarea-bordered w-full h-24 focus:border-teal-500 rounded-xl text-sm" placeholder="What needs to be changed?"></textarea>

			<div class="modal-action">
				<button class="btn btn-sm btn-ghost rounded-lg" onclick="annotation_modal.close()">Cancel</button>
				<button class="btn btn-sm btn-primary bg-teal-600 border-none hover:bg-teal-700 text-white rounded-lg px-6" onclick="submitAnnotation()">
					Post Feedback
				</button>
			</div>
		</div>
		<form method="dialog" class="modal-backdrop">
			<button>close</button>
		</form>
	</dialog>

	{# Floating Marker Button #}
	<button id="floating-comment-btn" class="hidden fixed z-[100] btn btn-circle btn-primary bg-teal-600 hover:bg-teal-700 border-none shadow-xl scale-90 transition-transform active:scale-75 shadow-teal-200/50">
		<i data-lucide="plus" class="w-6 h-6 text-white"></i>
	</button>

	<style>
		.custom-scrollbar::-webkit-scrollbar {
			width: 4px;
		}
		.custom-scrollbar::-webkit-scrollbar-track {
			background: transparent;
		}
		.custom-scrollbar::-webkit-scrollbar-thumb {
			background: #e5e7eb;
			border-radius: 2px;
		}
		.custom-scrollbar::-webkit-scrollbar-thumb:hover {
			background: #d1d5db;
		}

		::selection {
			background-color: rgba(20, 184, 166, 0.3);
			color: inherit;
		}

		.highlight-annotation {
			background-color: var(--ann-bg, rgba(20, 184, 166, 0.1));
			border-bottom: 2px dashed var(--ann-color, #14b8a6);
			cursor: pointer;
			transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
			position: relative;
			z-index: 1;
		}

		.highlight-annotation:hover {
			background-color: var(--ann-bg-hover, rgba(20, 184, 166, 0.2));
			z-index: 2;
		}

		.annotation-tooltip {
			position: absolute;
			bottom: calc(100% + 10px);
			left: 50%;
			transform: translateX(-50%) translateY(5px);
			background: #1e293b;
			color: white;
			padding: 6px 10px;
			border-radius: 6px;
			font-size: 10px;
			font-weight: 500;
			white-space: nowrap;
			z-index: 1000;
			pointer-events: none;
			opacity: 0;
			transition: all 0.2s;
			box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
		}

		.annotation-tooltip::after {
			content: '';
			position: absolute;
			top: 100%;
			left: 50%;
			transform: translateX(-50%);
			border: 5px solid transparent;
			border-top-color: #1e293b;
		}

		.highlight-annotation:hover .annotation-tooltip {
			opacity: 1;
			transform: translateX(-50%) translateY(0);
		}

		#post-body a {
			color: #14b8a6;
			text-decoration: underline;
			text-decoration-thickness: 1px;
			text-underline-offset: 4px;
			font-weight: 600;
			transition: all 0.2s;
		}
		#post-body a:hover {
			color: #0f766e;
			background: #f0fdfa;
			border-radius: 2px;
		}

		.ring-pulse {
			animation: ring-pulse-anim 1.5s infinite;
		}
		@keyframes ring-pulse-anim {
			0% {
				box-shadow: 0 0 0 0 var(--tw-ring-color);
				opacity: 1;
			}
			100% {
				box-shadow: 0 0 0 10px var(--tw-ring-color);
				opacity: 0;
			}
		}
	</style>

	<script>
		document.addEventListener('DOMContentLoaded', () => {
const previewBody = document.getElementById('post-body');
const floatingBtn = document.getElementById('floating-comment-btn');
let currentSelection = null;

// Admin Color Palette
const ADMIN_COLORS = [
{
name: 'Teal',
primary: '#14b8a6',
bg: 'rgba(20, 184, 166, 0.1)',
bgHover: 'rgba(20, 184, 166, 0.2)',
sidebarBg: 'bg-teal-600',
text: 'text-teal-600',
lightBg: 'bg-teal-50'
},
{
name: 'Indigo',
primary: '#6366f1',
bg: 'rgba(99, 102, 241, 0.1)',
bgHover: 'rgba(99, 102, 241, 0.2)',
sidebarBg: 'bg-indigo-600',
text: 'text-indigo-600',
lightBg: 'bg-indigo-50'
},
{
name: 'Rose',
primary: '#f43f5e',
bg: 'rgba(244, 63, 94, 0.1)',
bgHover: 'rgba(244, 63, 94, 0.2)',
sidebarBg: 'bg-rose-600',
text: 'text-rose-600',
lightBg: 'bg-rose-50'
},
{
name: 'Amber',
primary: '#f59e0b',
bg: 'rgba(245, 158, 11, 0.1)',
bgHover: 'rgba(245, 158, 11, 0.2)',
sidebarBg: 'bg-amber-600',
text: 'text-amber-600',
lightBg: 'bg-amber-50'
}, {
name: 'Violet',
primary: '#8b5cf6',
bg: 'rgba(139, 92, 246, 0.1)',
bgHover: 'rgba(139, 92, 246, 0.2)',
sidebarBg: 'bg-violet-600',
text: 'text-violet-600',
lightBg: 'bg-violet-50'
}, {
name: 'Orange',
primary: '#f97316',
bg: 'rgba(249, 115, 22, 0.1)',
bgHover: 'rgba(249, 115, 22, 0.2)',
sidebarBg: 'bg-orange-600',
text: 'text-orange-600',
lightBg: 'bg-orange-50'
}
];

const getAdminColor = (name) => {
let hash = 0;
for (let i = 0; i < name.length; i++) {
hash = name.charCodeAt(i) + ((hash << 5) - hash);
}
return ADMIN_COLORS[Math.abs(hash) % ADMIN_COLORS.length];
};

const isInside = (node, parent) => {
while (node) {
if (node === parent) 
return true;


node = node.parentNode;
}
return false;
};

// 1. Initial Highlighting
const restoreHighlights = () => {
const items = document.querySelectorAll('#annotations-list [data-id]');
items.forEach(el => {
const id = el.getAttribute('data-id');
const text = el.getAttribute('data-selected-text');
const author = el.querySelector('.author-name').innerText;
const time = el.querySelector('.annotation-time').innerText;

const color = getAdminColor(author);

// Style Sidebar Item
const avatar = el.querySelector('.author-avatar');
if (avatar) {
avatar.className = avatar.className.replace(/bg-teal-600/, color.sidebarBg);
}

const excerptBox = el.querySelector('.excerpt-box');
if (excerptBox) {
excerptBox.classList.remove('text-teal-600', 'bg-teal-50');
excerptBox.classList.add(color.text, color.lightBg);
excerptBox.style.borderLeft = `3px solid ${
color.primary
}`;
}

if (text && !el.classList.contains('grayscale')) {
highlightStringInBody({id, author, time, text});
}
});
};

const highlightStringInBody = (ann) => {
const body = document.getElementById('post-body');
const walker = document.createTreeWalker(body, NodeFilter.SHOW_TEXT, null, false);
let node;
while (node = walker.nextNode()) {
const idx = node.textContent.indexOf(ann.text);
if (idx !== -1) {
const range = document.createRange();
range.setStart(node, idx);
range.setEnd(node, idx + ann.text.length);
applyHighlight(range, ann);
break;
}
}
};

const applyHighlight = (range, ann) => {
const color = getAdminColor(ann.author);
const span = document.createElement('span');
span.className = 'highlight-annotation';
span.setAttribute('data-ann-id', ann.id);
span.style.setProperty('--ann-bg', color.bg);
span.style.setProperty('--ann-bg-hover', color.bgHover);
span.style.setProperty('--ann-color', color.primary);

const tooltip = document.createElement('div');
tooltip.className = 'annotation-tooltip';
tooltip.innerHTML = `<span style="color:${
color.primary
}">●</span> <strong>${
ann.author
}</strong> • ${
ann.time
}`;
span.appendChild(tooltip);

try {
range.surroundContents(span);
span.addEventListener('click', (e) => {
e.stopPropagation();
const sidebarItem = document.querySelector (`#annotations-list [data-id="${
ann.id
}"]`);
if (sidebarItem) {
sidebarItem.scrollIntoView({behavior: 'smooth', block: 'center'});
sidebarItem.classList.add('ring-2', 'ring-offset-2');
sidebarItem.style.setProperty('--tw-ring-color', color.primary);
setTimeout(() => {
sidebarItem.classList.remove('ring-2', 'ring-offset-2');
}, 2000);
}
});
} catch (e) {
console.warn('Highlight overlap detected, skipping markup for ID:', ann.id);
}
};

// 2. Selection Handling
const handleSelection = () => {
const selection = window.getSelection();
const text = selection.toString().trim();

if (text && selection.rangeCount > 0 && isInside(selection.anchorNode, previewBody)) {
currentSelection = {
text,
range: selection.getRangeAt(0).cloneRange()
};
const rect = selection.getRangeAt(0).getBoundingClientRect();

// Fixed element uses viewport coordinates. DO NOT add scrollY.
floatingBtn.style.left = `${
rect.left + (rect.width / 2) - 20
}px`;
floatingBtn.style.top = `${
rect.top - 55
}px`;

floatingBtn.classList.remove('hidden');
floatingBtn.classList.add('animate-in', 'zoom-in', 'duration-200');
} else {
floatingBtn.classList.add('hidden');
}
};

document.addEventListener('mouseup', handleSelection);

floatingBtn.addEventListener('click', (e) => {
e.preventDefault();
e.stopPropagation();
document.getElementById('selected-text-preview').innerText = `"${
currentSelection.text
}"`;
annotation_modal.showModal();
floatingBtn.classList.add('hidden');
setTimeout(() => document.getElementById('annotation-content').focus(), 150);
});

// 3. API Actions
window.submitAnnotation = async () => {
const content = document.getElementById('annotation-content').value.trim();
if (! content) 
return;



const btn = document.querySelector('#annotation_modal .btn-primary');
const originalText = btn.innerHTML;
btn.disabled = true;
btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';

try {
const res = await fetch("{{ path('admin_post_annotate', {id: post.id}) }}", {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'X-Requested-With': 'XMLHttpRequest'
},
body: JSON.stringify(
{content, selectedText: currentSelection.text, contextData: {}}
)
});
const data = await res.json();

if (data.status === 'success') {
applyHighlight(currentSelection.range, {
id: data.annotation.id,
author: data.annotation.authorName,
time: 'Just now',
text: currentSelection.text
});
addAnnotationToList(data.annotation);
annotation_modal.close();
document.getElementById('annotation-content').value = '';
document.getElementById('no-annotations-msg') ?. remove();
} else {
alert('Error: ' + (
data.message || 'Failed to post feedback'
));
}
} catch (err) {
console.error(err);
alert('Network error. Please try again.');
} finally {
btn.disabled = false;
btn.innerHTML = originalText;
}
};

const addAnnotationToList = (ann) => {
const color = getAdminColor(ann.authorName);
const list = document.getElementById('annotations-list');
const html = `
                    <div class="p-3 bg-white rounded-lg border border-l-4 shadow-sm animate-in slide-in-from-right-4 duration-300 relative group" 
                         data-id="${
ann.id
}" 
                         data-selected-text="${
ann.selectedText || currentSelection.text
}"
                         style="border-left-color: ${
color.primary
}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full ${
color.sidebarBg
} flex items-center justify-center text-[10px] text-white font-bold">
                                    ${
ann.authorName.charAt(0).toUpperCase()
}
                                </div>
                                <span class="text-xs font-bold text-gray-900">${
ann.authorName
}</span>
                            </div>
                            <span class="text-[10px] text-gray-400 font-medium">Just now</span>
                        </div>
                        <p class="text-[10px] ${
color.text
} italic ${
color.lightBg
} px-2 py-1.5 rounded mb-2 line-clamp-1 border-l-2" style="border-left-color: ${
color.primary
}">
                            "${
ann.selectedText || currentSelection.text
}"
                        </p>
                        <p class="text-sm text-gray-700 leading-relaxed mb-1">${
ann.content
}</p>
                        <div class="mt-3 flex justify-end gap-1">
                            <button class="btn btn-sm btn-ghost btn-xs text-[10px] text-error opacity-0 group-hover:opacity-100 transition-opacity px-1" onclick="deleteAnnotation(${
ann.id
})">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> Delete
                            </button>
                            <button class="btn btn-sm btn-ghost btn-xs text-[10px] text-teal-600 opacity-0 group-hover:opacity-100 transition-opacity px-1 resolve-btn" onclick="resolveAnnotation(${
ann.id
})">
                                <i data-lucide="check-circle" class="w-3 h-3"></i> Resolve
                            </button>
                        </div>
                    </div>
                `;
list.insertAdjacentHTML('afterbegin', html);
const count = document.getElementById('annotation-count');
count.innerText = parseInt(count.innerText) + 1;
if (window.lucide) 
window.lucide.createIcons();


};

window.resolveAnnotation = async (id) => {
try {
const res = await fetch (`/admin/annotations/${id}/resolve`, {
method: 'POST',
headers: {
'X-Requested-With': 'XMLHttpRequest'
}
});
if (res.ok) {
const item = document.querySelector (`[data-id="${id}"]`);
if (item) {
item.classList.add('opacity-50', 'grayscale');
item.style.borderLeftColor = '#e5e7eb';
item.querySelector('.resolve-btn') ?. remove();
}
const highlight = document.querySelector (`.highlight-annotation[data-ann-id="${id}"]`);
if (highlight) {
highlight.style.backgroundColor = 'transparent';
highlight.style.borderBottom = 'none';
highlight.style.opacity = '0.4';
}
} else {
alert('Server error while resolving.');
}
} catch (err) {
console.error(err);
}
};

window.deleteAnnotation = async (id) => {
try {
const res = await fetch (`/admin/annotations/${id}/delete`, {
method: 'POST',
headers: {
'X-Requested-With': 'XMLHttpRequest'
}
});
if (res.ok) {
const item = document.querySelector (`[data-id="${id}"]`);
if (item) {
item.classList.add('scale-90', 'opacity-0');
setTimeout(() => item.remove(), 250);
}
const highlight = document.querySelector (`.highlight-annotation[data-ann-id="${id}"]`);
if (highlight) {
const parent = highlight.parentNode;
while (highlight.firstChild) {
if (highlight.firstChild.className !== 'annotation-tooltip') {
parent.insertBefore(highlight.firstChild, highlight);
} else {
highlight.removeChild(highlight.firstChild);
}
}
parent.removeChild(highlight);
parent.normalize();
}
const count = document.getElementById('annotation-count');
count.innerText = Math.max(0, parseInt(count.innerText) - 1);
} else {
alert('Server error while deleting.');
}
} catch (err) {
console.error(err);
}
};

// Init
restoreHighlights();
if (window.lucide) 
window.lucide.createIcons();


});
	</script>
{% endblock %}
