{% extends 'author/layout.html.twig' %}

{% block title %}My Profile - Blogify
{% endblock %}

{% block author_content %}
	{# Cropper.js CDN #}
	<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

	<div class="max-w-4xl mx-auto">
		<div class="mb-8">
			<h1 class="text-2xl font-bold text-gray-900">Your Author Profile</h1>
			<p class="text-gray-500 text-sm mt-1">Manage your account details and biography</p>
		</div>

		<div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
			<div class="px-8 py-10">
				<form id="profileForm" action="{{ path('author_profile') }}" method="POST" class="space-y-8">
					<div
						class="flex flex-col md:flex-row gap-10 items-start">
						{# Avatar Placeholder #}
						<div class="w-full md:w-1/3 flex flex-col items-center">
							<div class="relative group cursor-pointer" id="avatarTrigger">
								<div class="w-32 h-32 rounded-full bg-teal-100 flex items-center justify-center border-4 border-white shadow-md overflow-hidden">
									{% if user.avatarData %}
										<img id="avatarPreview" src="{{ path('user_avatar', {id: user.id}) }}" class="w-full h-full object-cover">
									{% else %}
										<span id="avatarInitial" class="text-4xl font-bold text-teal-600">{{ user.name|first|upper }}</span>
										<img id="avatarPreview" src="" class="w-full h-full object-cover hidden">
									{% endif %}
								</div>
								<div class="absolute inset-0 bg-black/20 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
									<i data-lucide="camera" class="w-8 h-8 text-white"></i>
								</div>
								<input type="file" id="avatarInput" class="hidden" accept="image/*">
								<input type="hidden" name="cropped_avatar" id="croppedAvatar">
							</div>
							<p class="text-xs text-gray-400 mt-4 text-center italic">Click to change avatar</p>
						</div>

						{# Form Fields #}
						<div class="w-full md:w-2/3 space-y-6">
							<div class="grid grid-cols-1 gap-6">
								<div class="form-control">
									<label class="label">
										<span class="label-text font-bold text-gray-700">Display Name</span>
									</label>
									<input type="text" name="name" value="{{ user.name }}" class="input input-bordered focus:border-teal-500 rounded-xl" required>
								</div>

								<div class="form-control">
									<label class="label">
										<span class="label-text font-bold text-gray-700">Email Address</span>
									</label>
									<input type="email" value="{{ user.email }}" class="input input-bordered bg-gray-50 text-gray-400 rounded-xl" disabled>
									<label class="label">
										<span class="label-text-alt text-gray-400 italic">Email cannot be changed</span>
									</label>
								</div>

								<div class="form-control">
									<label class="label">
										<span class="label-text font-bold text-gray-700">About You</span>
									</label>
									<textarea name="biography" class="textarea textarea-bordered h-32 focus:border-teal-500 rounded-xl" placeholder="Tell your readers about yourself...">{{ user.biography }}</textarea>
								</div>

								<div class="divider"></div>

								<div class="form-control">
									<label class="label">
										<span class="label-text font-bold text-gray-700">Change Password</span>
									</label>
									<input type="password" name="password" placeholder="Leave blank to keep current" class="input input-bordered focus:border-teal-500 rounded-xl">
								</div>
							</div>
						</div>
					</div>

					<div class="flex justify-end gap-3 pt-6 border-t border-gray-100">
						<button type="submit" class="btn btn-primary bg-teal-600 border-none hover:bg-teal-700 text-white rounded-xl px-10">
							Update Profile
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	{# Crop Modal #}
	<div id="cropModal" class="relative z-[200] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
		<div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity"></div>
		<div class="fixed inset-0 z-10 overflow-y-auto">
			<div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
				<div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
					<div class="bg-white px-6 pt-6 pb-4">
						<h3 class="text-xl font-bold text-gray-900 mb-4">Adjust your avatar</h3>
						<div class="aspect-square w-full bg-gray-100 rounded-xl overflow-hidden">
							<img id="imageToCrop" class="max-w-full block" src="">
						</div>
					</div>
					<div class="bg-gray-50 px-6 py-4 flex flex-col sm:flex-row-reverse gap-3">
						<button type="button" id="cropBtn" class="btn btn-primary bg-teal-600 border-none hover:bg-teal-700 text-white rounded-xl flex-1">
							Apply Change
						</button>
						<button type="button" onclick="closeCropModal()" class="btn btn-ghost rounded-xl flex-1">
							Cancel
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		let cropper;
const avatarInput = document.getElementById('avatarInput');
const avatarTrigger = document.getElementById('avatarTrigger');
const cropModal = document.getElementById('cropModal');
const imageToCrop = document.getElementById('imageToCrop');
const avatarPreview = document.getElementById('avatarPreview');
const avatarInitial = document.getElementById('avatarInitial');
const cropBtn = document.getElementById('cropBtn');
const croppedAvatarInput = document.getElementById('croppedAvatar');

avatarTrigger.addEventListener('click', () => avatarInput.click());

avatarInput.addEventListener('change', function (e) {
const files = e.target.files;
if (files && files.length > 0) {
const reader = new FileReader();
reader.onload = function (event) {
imageToCrop.src = event.target.result;
showCropModal();

if (cropper) {
cropper.destroy();
}
cropper = new Cropper(imageToCrop, {
aspectRatio: 1,
viewMode: 1,
autoCropArea: 1
});
};
reader.readAsDataURL(files[0]);
}
});

cropBtn.addEventListener('click', function () {
if (! cropper) 
return;


const canvas = cropper.getCroppedCanvas({width: 400, height: 400});
const base64Image = canvas.toDataURL('image/jpeg', 0.8);

avatarPreview.src = base64Image;
avatarPreview.classList.remove('hidden');
if (avatarInitial) 
avatarInitial.classList.add('hidden');


croppedAvatarInput.value = base64Image;
closeCropModal();
});

function showCropModal() {
cropModal.classList.remove('hidden');
}

function closeCropModal() {
cropModal.classList.add('hidden');
}
	</script>
{% endblock %}
